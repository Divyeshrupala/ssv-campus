<!DOCTYPE HTML>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>Admin Panel ‚Äî Shree Vardayini High School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { 
            background: #f8f9fa;
            font-family: 'Source Sans Pro', sans-serif;
        }
        .admin-header {
            background: linear-gradient(45deg, rgb(96, 40, 21), rgb(124, 61, 3));
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .admin-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        .btn-primary {
            background: linear-gradient(45deg, rgb(96, 40, 21), rgb(124, 61, 3));
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
        }
        .btn-success {
            background: #28a745;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
        }
        .btn-danger {
            background: #dc3545;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
        }
        .btn-warning {
            background: #ffc107;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            color: #212529;
        }
        .form-control {
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            padding: 10px 15px;
        }
        .form-control:focus {
            border-color: rgb(96, 40, 21);
            box-shadow: 0 0 0 0.2rem rgba(96, 40, 21, 0.25);
        }
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        .table thead th {
            background: rgb(96, 40, 21);
            color: white;
            border: none;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        .status-used {
            background: #d1ecf1;
            color: #0c5460;
        }
        .alert {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="admin-header">
    <div class="container">
        <div class="row">
            <div class="col-md-8">
                <h2><i class="fas fa-user-shield"></i> Admin Panel - Shree Vardayini High School</h2>
                <p class="mb-0">Manage faculty pre-approvals and registrations</p>
            </div>
            <div class="col-md-4 text-right">
                <a href="index.html" class="btn btn-outline-light">
                    <i class="fas fa-home"></i> Back to Website
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Alert Messages -->
    <div id="alertMessage" style="display: none;"></div>

    <!-- Add New Faculty Form -->
    <div class="admin-card">
        <h4><i class="fas fa-user-plus"></i> Add New Faculty for Pre-Approval</h4>
        <hr>
        <form id="addFacultyForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="facultyName" class="form-control" placeholder="Enter faculty full name" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" id="facultyEmail" class="form-control" placeholder="faculty@vardayinischool.com" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="facultyPhone" class="form-control" placeholder="+91 98765 43210">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Subject Expertise</label>
                        <input type="text" id="facultySubject" class="form-control" placeholder="e.g., Mathematics, English">
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Faculty for Approval
            </button>
        </form>
    </div>

    <!-- Faculty List -->
    <div class="admin-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-list"></i> Faculty Pre-Approval List</h4>
            <button onclick="loadFacultyList()" class="btn btn-outline-primary">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        <hr>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Added On</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="facultyTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Loading faculty list...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Contact Messages -->
    <div class="admin-card">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-envelope"></i> Contact Form Messages</h4>
            <button onclick="loadContactMessages()" class="btn btn-outline-primary">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
        <hr>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Subject</th>
                        <th>Message</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contactTableBody">
                    <tr>
                        <td colspan="7" class="text-center">Loading contact messages...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-config.js"></script>

<script>
    // Show alert message
    function showAlert(message, type = 'danger') {
        const alertDiv = document.getElementById('alertMessage');
        alertDiv.style.display = 'block';
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}" style="margin-right: 8px;"></i>
            ${message}
        `;
        
        // Auto hide success messages
        if (type === 'success') {
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Hide alert message
    function hideAlert() {
        document.getElementById('alertMessage').style.display = 'none';
    }

    // Add Faculty Form Handler
    document.getElementById('addFacultyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        hideAlert();

        console.log('=== ADMIN PANEL DEBUG ===');
        console.log('Form submitted');

        const formData = {
            full_name: document.getElementById('facultyName').value.trim(),
            email: document.getElementById('facultyEmail').value.trim().toLowerCase(),
            phone: document.getElementById('facultyPhone').value.trim(),
            subject_expertise: document.getElementById('facultySubject').value.trim(),
            status: 'approved'
        };

        console.log('Form data:', formData);

        // Validate required fields
        if (!formData.full_name || !formData.email) {
            showAlert('Please fill in all required fields.');
            return;
        }

        // Generate structured password (name@DDMMYY format)
        const birthDate = prompt('Enter birth date (DD/MM/YYYY):');
        if (!birthDate) {
            showAlert('Birth date is required for password generation.');
            return;
        }

        console.log('Birth date entered:', birthDate);

        // Validate birth date format
        const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
        if (!dateRegex.test(birthDate)) {
            showAlert('Please enter birth date in DD/MM/YYYY format.');
            return;
        }

        const [day, month, year] = birthDate.split('/');
        const shortYear = year.slice(-2);
        const firstName = formData.full_name.split(' ')[0].toLowerCase();
        const structuredPassword = `${firstName}@${day}${month}${shortYear}`;
        
        formData.birth_date = `${year}-${month}-${day}`;
        formData.password = structuredPassword;

        console.log('Final form data with password:', formData);

        try {
            // Test Supabase connection first
            console.log('Testing Supabase connection...');
            const { data: testData, error: testError } = await _supabase
                .from('faculty_preapproval')
                .select('count', { count: 'exact' });
            
            if (testError) {
                console.error('Supabase connection test failed:', testError);
                showAlert(`Database connection failed: ${testError.message}`);
                return;
            }
            
            console.log('‚úÖ Supabase connection successful');

            // Step 1: Add to database
            console.log('Step 1: Adding to database...');
            showAlert('Adding faculty to database...', 'info');
            
            const { data, error } = await _supabase
                .from('faculty_preapproval')
                .insert([formData])
                .select();

            console.log('Database insert result:', { data, error });

            if (error) {
                console.error('Database insert error:', error);
                throw error;
            }

            console.log('‚úÖ Database insert successful');

            // Step 2: Create Auth account automatically
            console.log('Step 2: Creating auth account...');
            showAlert('Creating auth account...', 'info');
            
            const { data: authData, error: authError } = await _supabase.auth.signUp({
                email: formData.email,
                password: structuredPassword,
                options: {
                    data: {
                        full_name: formData.full_name,
                        role: 'faculty',
                        phone: formData.phone,
                        roll_no: '',
                        standard: '',
                        subject_expertise: formData.subject_expertise
                    }
                }
            });

            console.log('Auth creation result:', { authData, authError });

            if (authError && !authError.message.includes('already registered')) {
                console.error('Auth creation error:', authError);
                showAlert(`‚úÖ Faculty added to database successfully!<br>
                ‚ö†Ô∏è Auth creation failed: ${authError.message}<br>
                Please create auth account manually.`, 'warning');
            } else {
                console.log('‚úÖ Auth account created successfully');
                showAlert(`üéâ Faculty added successfully! 
                <br><strong>Login Credentials:</strong>
                <br>üìß Email: ${formData.email}
                <br>üîê Password: ${structuredPassword}
                <br>üìÖ Birth Date: ${birthDate}
                <br><br>‚úÖ Database entry created
                <br>‚úÖ Auth account created`, 'success');
            }

            document.getElementById('addFacultyForm').reset();
            loadFacultyList();

        } catch (error) {
            console.error('‚ùå Error adding faculty:', error);
            if (error.code === '23505') {
                showAlert('‚ùå This email is already registered.');
            } else {
                showAlert(`‚ùå Error adding faculty: ${error.message}`);
            }
        }
    });

    // Load Faculty List
    async function loadFacultyList() {
        console.log('=== LOADING FACULTY LIST ===');
        try {
            console.log('Fetching faculty data from Supabase...');
            const { data: faculty, error } = await _supabase
                .from('faculty_preapproval')
                .select('*')
                .order('created_at', { ascending: false });

            console.log('Faculty fetch result:', { faculty, error });

            if (error) {
                console.error('‚ùå Error fetching faculty:', error);
                throw error;
            }

            const tbody = document.getElementById('facultyTableBody');
            
            if (!faculty || faculty.length === 0) {
                console.log('No faculty found in database');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No faculty found.</td></tr>';
                return;
            }

            console.log(`‚úÖ Found ${faculty.length} faculty members`);
            tbody.innerHTML = '';
            faculty.forEach((f, index) => {
                console.log(`Faculty ${index + 1}:`, f);
                const statusClass = f.status === 'approved' ? 'status-approved' : 
                                  f.status === 'used' ? 'status-used' : 'status-pending';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${f.full_name}</td>
                        <td>${f.email}</td>
                        <td>${f.phone || 'N/A'}</td>
                        <td>${f.subject_expertise || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${f.status.toUpperCase()}</span></td>
                        <td>${new Date(f.created_at).toLocaleDateString()}</td>
                        <td>
                            ${f.status === 'pending' ? 
                                `<button onclick="updateFacultyStatus('${f.id}', 'approved')" class="btn btn-success btn-sm">
                                    <i class="fas fa-check"></i> Approve
                                </button>` : ''}
                            <button onclick="deleteFaculty('${f.id}')" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });

        } catch (error) {
            console.error('‚ùå Error loading faculty:', error);
            document.getElementById('facultyTableBody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading faculty list: ' + error.message + '</td></tr>';
        }
    }

    // Update Faculty Status
    async function updateFacultyStatus(id, status) {
        try {
            const { error } = await _supabase
                .from('faculty_preapproval')
                .update({ status: status })
                .eq('id', id);

            if (error) throw error;

            showAlert(`Faculty ${status} successfully!`, 'success');
            loadFacultyList();

        } catch (error) {
            console.error('Error updating faculty status:', error);
            showAlert('Error updating faculty status: ' + error.message);
        }
    }

    // Delete Faculty
    async function deleteFaculty(id) {
        if (!confirm('Are you sure you want to delete this faculty record?')) {
            return;
        }

        try {
            const { error } = await _supabase
                .from('faculty_preapproval')
                .delete()
                .eq('id', id);

            if (error) throw error;

            showAlert('Faculty deleted successfully!', 'success');
            loadFacultyList();

        } catch (error) {
            console.error('Error deleting faculty:', error);
            showAlert('Error deleting faculty: ' + error.message);
        }
    }

    // Load Contact Messages
    async function loadContactMessages() {
        try {
            const { data: contacts, error } = await _supabase
                .from('contacts')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            const tbody = document.getElementById('contactTableBody');
            
            if (!contacts || contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No contact messages found.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            contacts.forEach(c => {
                const statusClass = c.status === 'read' ? 'status-approved' : 'status-pending';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${c.first_name} ${c.last_name}</td>
                        <td>${c.email}</td>
                        <td>${c.subject}</td>
                        <td>${c.message.substring(0, 50)}${c.message.length > 50 ? '...' : ''}</td>
                        <td>${new Date(c.created_at).toLocaleDateString()}</td>
                        <td><span class="status-badge ${statusClass}">${c.status.toUpperCase()}</span></td>
                        <td>
                            ${c.status === 'new' ? 
                                `<button onclick="markAsRead('${c.id}')" class="btn btn-warning btn-sm">
                                    <i class="fas fa-eye"></i> Mark Read
                                </button>` : ''}
                            <button onclick="deleteContact('${c.id}')" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });

        } catch (error) {
            console.error('Error loading contacts:', error);
            document.getElementById('contactTableBody').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading contact messages.</td></tr>';
        }
    }

    // Mark Contact as Read
    async function markAsRead(id) {
        try {
            const { error } = await _supabase
                .from('contacts')
                .update({ status: 'read' })
                .eq('id', id);

            if (error) throw error;

            showAlert('Message marked as read!', 'success');
            loadContactMessages();

        } catch (error) {
            console.error('Error marking as read:', error);
            showAlert('Error marking message as read: ' + error.message);
        }
    }

    // Delete Contact
    async function deleteContact(id) {
        if (!confirm('Are you sure you want to delete this contact message?')) {
            return;
        }

        try {
            const { error } = await _supabase
                .from('contacts')
                .delete()
                .eq('id', id);

            if (error) throw error;

            showAlert('Contact message deleted successfully!', 'success');
            loadContactMessages();

        } catch (error) {
            console.error('Error deleting contact:', error);
            showAlert('Error deleting contact message: ' + error.message);
        }
    }

    // Load data on page load
    window.addEventListener('load', async () => {
        console.log('=== ADMIN PANEL PAGE LOADED ===');
        console.log('Testing Supabase connection...');
        
        try {
            // Test connection
            const { data: testData, error: testError } = await _supabase
                .from('faculty_preapproval')
                .select('count', { count: 'exact' });
            
            if (testError) {
                console.error('‚ùå Supabase connection failed:', testError);
                showAlert(`Database connection failed: ${testError.message}`, 'danger');
                return;
            }
            
            console.log('‚úÖ Supabase connection successful');
            console.log('Faculty count:', testData);
            
            // Load data
            loadFacultyList();
            loadContactMessages();
            
        } catch (error) {
            console.error('‚ùå Page load error:', error);
            showAlert(`Page load error: ${error.message}`, 'danger');
        }
    });
</script>
</body>
</html>