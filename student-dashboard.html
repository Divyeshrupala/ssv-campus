<!DOCTYPE HTML>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>Student Dashboard — Shree Vardayini High School</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sidebar-bg: #7c3d03;
            --accent: #ffd700;
            --body-bg: #f8f9fc;
        }

        body { background-color: var(--body-bg); font-family: 'Segoe UI', sans-serif; margin: 0; }

        .navigation-pane {
            width: 270px; height: 94vh; position: fixed; top: 3vh; left: 20px;
            background: linear-gradient(180deg, #7c3d03 0%, #4e2602 100%);
            border-radius: 30px; padding: 35px 20px; display: flex; flex-direction: column; z-index: 1000;
        }

        .nav-link-item {
            color: rgba(255,255,255,0.75); padding: 14px 22px; margin-bottom: 10px;
            border-radius: 15px; text-decoration: none; display: block; cursor: pointer; transition: 0.3s;
        }

        .nav-link-item:hover, .nav-link-item.active {
            background: var(--accent); color: #7c3d03; font-weight: bold;
        }

        .main-wrapper { margin-left: 310px; padding: 40px; }

        .dashboard-section { display: none; animation: fadeIn 0.5s ease; }
        .dashboard-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card {
            background: white; border-radius: 25px; padding: 30px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.06); margin-bottom: 30px;
        }

        .status-pill { padding: 6px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; }
        .pass-pill { background: #dff9fb; color: #130f40; }
        .fail-pill { background: #fab1a0; color: #d63031; }

        .logout-link-box { margin-top: auto; padding: 12px; border: 1px solid var(--accent); border-radius: 15px; text-align: center; color: var(--accent); text-decoration: none; }
        
        .nav-header {
            margin-bottom: 20px;
            padding: 10px;
            text-align: center;
        }
        
        .nav-header a {
            color: var(--accent);
            text-decoration: none;
            font-size: 14px;
        }
        
        .nav-header a:hover {
            color: white;
        }
    </style>
</head>
<body>

<div id="page">

<div class="navigation-pane">
    <div class="nav-header">
        <a href="index.html">← Back to Website</a>
    </div>
    
    <div class="brand-logo" style="text-align: center; margin-bottom: 40px;">
        <img src="images/logo/logo.png" alt="Logo" style="max-width: 150px;">
    </div>
    
    <a onclick="showSection('performance')" id="nav-performance" class="nav-link-item active">My Performance</a>
    <a onclick="showSection('materials')" id="nav-materials" class="nav-link-item">Study Materials</a>
    <a onclick="showSection('timetable')" id="nav-timetable" class="nav-link-item">Time Table</a>
    
    <a href="#" onclick="logout()" class="logout-link-box">Logout Portal</a>
</div>

<div class="main-wrapper">
    <div class="glass-card" style="border-left: 10px solid var(--sidebar-bg); display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 id="welcome-msg" style="font-weight: 800; color: #7c3d03;">Loading...</h2>
            <p class="mb-0 text-muted">Roll No: <span id="roll-no" class="font-weight-bold text-dark">--</span> | Standard: <span id="std-no" class="font-weight-bold text-dark">--</span></p>
        </div>
    </div>

    <div id="section-performance" class="dashboard-section active">
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items: center; margin-bottom: 20px;">
                <h4 style="font-weight: 700;">Subject Wise Report Card</h4>
                <select id="year-select" class="form-control w-25" onchange="loadMarks()">
                    <option value="2024-2025">2024-2025</option>
                    <option value="2023-2024">2023-2024</option>
                </select>
            </div>
            <table class="table">
                <thead><tr><th>Subject</th><th>Marks</th><th>Result</th></tr></thead>
                <tbody id="marks-table"></tbody>
            </table>
        </div>
    </div>

    <div id="section-materials" class="dashboard-section">
        <div class="glass-card">
            <h4 style="font-weight: 700;">Reference Books & Notes</h4>
            <div id="materials-container" class="row mt-4">
                </div>
        </div>
    </div>

    <div id="section-timetable" class="dashboard-section">
        <div class="glass-card">
            <h4 style="font-weight: 700;">Weekly Class Schedule</h4>
            <div class="table-responsive mt-4">
                <table class="table table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 15%;">Day</th>
                            <th style="width: 35%;">Subject</th>
                            <th style="width: 25%;">Time</th>
                            <th style="width: 25%;">Room</th>
                        </tr>
                    </thead>
                    <tbody id="timetable-table">
                        <tr><td colspan='4' class='text-center'>Loading timetable...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _supabase = supabase.createClient('https://tqphwqjhiidgaohzllyw.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcGh3cWpoaWlkZ2FvaHpsbHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTEyNDIsImV4cCI6MjA4MzI4NzI0Mn0.CvxIEgEcO64TKPyHGbG1Ht-MbCpeNsPWEq1exWWvw2o');

    let currentUserProfile = null;

    async function checkUser() {
        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) { window.location.href = 'login.html'; return; }

        const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
        if (profile) {
            currentUserProfile = profile;
            document.getElementById('welcome-msg').innerText = "Hello, " + profile.full_name;
            document.getElementById('roll-no').innerText = profile.roll_no;
            document.getElementById('std-no').innerText = profile.standard;
            loadMarks();
        }
    }

    // Section Switcher Logic
    function showSection(sectionId) {
        // Hide all
        document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link-item').forEach(n => n.classList.remove('active'));
        
        // Show selected
        document.getElementById('section-' + sectionId).classList.add('active');
        document.getElementById('nav-' + sectionId).classList.add('active');

        // Load data based on section
        if(sectionId === 'performance') loadMarks();
        if(sectionId === 'materials') loadMaterials();
        if(sectionId === 'timetable') loadTimetable();
    }

    async function loadMarks() {
        const year = document.getElementById('year-select').value;
        const { data: marks } = await _supabase.from('marks').select('*').eq('student_id', currentUserProfile.id).eq('academic_year', year);
        
        const table = document.getElementById('marks-table');
        table.innerHTML = marks?.length ? "" : "<tr><td colspan='3' class='text-center'>No Data Found</td></tr>";
        
        marks?.forEach(m => {
            const isPass = m.score >= 35;
            table.innerHTML += `<tr>
                <td>${m.subject}</td>
                <td><b>${m.score}</b>/100</td>
                <td><span class="status-pill ${isPass?'pass-pill':'fail-pill'}">${isPass?'PASS':'FAIL'}</span></td>
            </tr>`;
        });
    }

    async function loadMaterials() {
    const container = document.getElementById('materials-container');
    
    if (!currentUserProfile) return;

    // 1. Get student's standard (e.g., "10" or "10th")
    let std = currentUserProfile.standard.toString().trim();
    
    // 2. Create a search array to handle both formats (10 and 10th)
    // This ensures that if the DB has "10th" but student is "10", it still works.
    let searchTerms = [std];
    if (!std.toLowerCase().endsWith('th')) {
        searchTerms.push(std + 'th');
    } else {
        searchTerms.push(std.replace(/th/i, ''));
    }

    container.innerHTML = `<div class="col-12 text-center"><p>Loading materials for Grade ${std}...</p></div>`;

    // 3. Fetch from Supabase using 'in' filter to match any of our search terms
    const { data: mats, error } = await _supabase
        .from('materials')
        .select(`
            *,
            profiles:uploaded_by (
                full_name
            )
        `)
        .in('standard', searchTerms) 
        .order('created_at', { ascending: false });

    if (error) {
        console.error("Supabase Error:", error);
        container.innerHTML = "<p class='ml-3 text-danger'>Connection error.</p>";
        return;
    }

    if (!mats || mats.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="fas fa-folder-open fa-3x mb-3" style="color: #ccc;"></i>
                <p class="text-muted">No materials found matching "${std}".<br>
                <small>Check if Supabase 'standard' column matches exactly.</small></p>
            </div>`;
        return;
    }

    // 4. Render the cards
    container.innerHTML = ""; 
    mats.forEach(m => {
        container.innerHTML += `
            <div class="col-md-4 mb-4">
                <div class="glass-card p-4 h-100 border-0 shadow-sm" style="border-radius: 20px;">
                    <div class="d-flex align-items-center mb-3">
                        <div style="background: #fff9e6; padding: 10px; border-radius: 12px; margin-right: 15px;">
                            <i class="fas fa-file-pdf" style="color: #7c3d03; font-size: 24px;"></i>
                        </div>
                        <h6 class="mb-0" style="font-weight: 700; color: #4e2602;">${m.subject}</h6>
                    </div>
                    <h5 style="font-size: 16px; font-weight: 600;">${m.title}</h5>
                    <p class="small text-muted mb-2">Grade: ${m.standard}</p>
                    <p class="small text-muted mb-2"><i class="fas fa-file-pdf mr-1"></i> PDF Document</p>
                    ${m.profiles && m.profiles.full_name ? `<p class="small text-muted mb-4"><i class="fas fa-user mr-1"></i> Uploaded by: ${m.profiles.full_name}</p>` : '<div class="mb-4"></div>'}
                    <a href="${m.file_url}" target="_blank" class="btn btn-sm btn-block" 
                       style="background: var(--sidebar-bg); color: white; border-radius: 10px; font-weight: 600;">
                        <i class="fas fa-external-link-alt mr-2"></i> Open PDF
                    </a>
                </div>
            </div>`;
    });
}

    async function loadTimetable() {
        if (!currentUserProfile) return;

        // Get student's standard and create search terms like we did for materials
        let std = currentUserProfile.standard.toString().trim();
        let searchTerms = [std];
        if (!std.toLowerCase().endsWith('th')) {
            searchTerms.push(std + 'th');
        } else {
            searchTerms.push(std.replace(/th/i, ''));
        }

        console.log("Loading timetable for standard:", std, "Search terms:", searchTerms);

        const { data: schedule, error } = await _supabase
            .from('timetable')
            .select('*')
            .in('standard', searchTerms)
            .order('day_of_week', { ascending: true })
            .order('start_time', { ascending: true });

        console.log("Timetable data:", schedule, "Error:", error);

        const table = document.getElementById('timetable-table');
        
        if (error) {
            console.error("Timetable Error:", error);
            table.innerHTML = "<tr><td colspan='4' class='text-center text-danger'>Error loading timetable.</td></tr>";
            return;
        }

        if (!schedule || schedule.length === 0) {
            table.innerHTML = `<tr><td colspan='4' class='text-center'>No timetable found for Grade ${std}.<br><small>Available standards in database should match: ${searchTerms.join(', ')}</small></td></tr>`;
            return;
        }

        // Clear table and populate with data
        table.innerHTML = "";
        
        // Group by day for better organization
        const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const groupedSchedule = {};
        
        schedule.forEach(s => {
            if (!groupedSchedule[s.day_of_week]) {
                groupedSchedule[s.day_of_week] = [];
            }
            groupedSchedule[s.day_of_week].push(s);
        });

        // Display in day order
        dayOrder.forEach(day => {
            if (groupedSchedule[day]) {
                groupedSchedule[day].forEach((s, index) => {
                    // Format time to 12-hour format
                    const startTime = formatTime(s.start_time);
                    const endTime = formatTime(s.end_time);
                    
                    table.innerHTML += `<tr>
                        <td>${index === 0 ? `<strong>${s.day_of_week}</strong>` : ''}</td>
                        <td>${s.subject}</td>
                        <td>${startTime} - ${endTime}</td>
                        <td>Room ${s.room_no}</td>
                    </tr>`;
                });
            }
        });
    }

    // Helper function to format time
    function formatTime(timeString) {
        const time = new Date(`1970-01-01T${timeString}`);
        return time.toLocaleTimeString('en-US', { 
            hour: 'numeric', 
            minute: '2-digit', 
            hour12: true 
        });
    }

    async function logout() { await _supabase.auth.signOut(); window.location.href = 'login.html'; }
    window.onload = checkUser;
</script>

</div> <!-- End of page div -->
</body>
</html>
