<!DOCTYPE HTML>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <title>Faculty Portal â€” SSV Campus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <style>
        :root {
            --sidebar-bg: #7c3d03;
            --accent: #ffd700;
            --body-bg: #f8f9fc;
            --glass: rgba(255, 255, 255, 0.9);
        }

        body { background-color: var(--body-bg); font-family: 'Poppins', sans-serif; color: #2d3436; }

        .navigation-pane {
            width: 280px; height: 94vh; position: fixed; top: 3vh; left: 20px;
            background: linear-gradient(180deg, #7c3d03 0%, #4e2602 100%);
            border-radius: 30px; padding: 40px 20px; display: flex; flex-direction: column; z-index: 1000;
        }

        .nav-item {
            color: rgba(255,255,255,0.7); padding: 15px 25px; margin-bottom: 10px;
            border-radius: 15px; text-decoration: none; display: flex; align-items: center; cursor: pointer; transition: 0.4s;
        }

        .nav-item i { margin-right: 15px; font-size: 18px; }
        .nav-item:hover, .nav-item.active { background: var(--accent); color: #7c3d03; font-weight: bold; text-decoration: none; }

        .main-wrapper { margin-left: 320px; padding: 40px; }
        .dashboard-section { display: none; animation: fadeIn 0.5s ease; }
        .dashboard-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }

        .glass-card {
            background: var(--glass); border-radius: 25px; padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        .header-title { font-size: 28px; font-weight: 700; color: #7c3d03; margin-bottom: 30px; }
        .btn-glow { background: #7c3d03; color: white; border-radius: 12px; padding: 10px 25px; border: none; font-weight: 600; transition: 0.3s; }
        .btn-glow:hover { background: #a15004; box-shadow: 0 8px 20px rgba(124, 61, 3, 0.3); }
        .styled-input { background: #f1f2f6; border: 2px solid transparent; border-radius: 15px; padding: 12px 15px; width: 100%; margin-bottom: 15px; }
        
        /* New Styles for Records */
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: #fff9e6 !important; }
        .detail-box { background: white; border: 2px solid #eee; border-radius: 15px; padding: 20px; margin: 10px 0; }
    </style>
</head>
<body>

<div class="navigation-pane">
    <div class="brand-logo" style="text-align:center; margin-bottom:50px;">
        <img src="images/logo/logo-no-bg2.png" alt="Logo" style="max-width:180px;">
    </div>

    <a onclick="showSection('entry')" id="nav-entry" class="nav-item active"><i class="fas fa-user-edit"></i> Mark Entry</a>
    <a onclick="showSection('records')" id="nav-records" class="nav-item"><i class="fas fa-list-alt"></i> View Records</a>
    
    <div style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
        <a href="#" onclick="handleLogout()" class="nav-item" style="color: var(--accent);">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>
</div>

<div class="main-wrapper">
    <h1 class="header-title" id="faculty-welcome">Faculty Control Center</h1>

    <div id="section-entry" class="dashboard-section active">
        <div class="row">
            <div class="col-lg-5">
                <div class="glass-card">
                    <h4 class="mb-4">Search Student</h4>
                    <div class="d-flex mb-3">
                        <input type="text" id="search-roll" class="styled-input mb-0 mr-2" placeholder="Roll Number">
                        <button class="btn-glow" onclick="searchStudent()">Search</button>
                    </div>
                    <div id="student-result" style="display:none; background: #fff; padding: 15px; border-radius: 15px; border-left: 5px solid var(--accent);">
                        <p class="small text-muted mb-0">STUDENT IDENTIFIED</p>
                        <h5 id="res-name" class="font-weight-bold">--</h5>
                        <span id="res-std" class="badge badge-warning">--</span>
                        <input type="hidden" id="target-student-id">
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="glass-card">
                    <h4 class="mb-4">Result Entry Form</h4>
                    <label>Academic Session</label>
                    <select id="marks-year" class="styled-input">
                        <option value="2024-2025">2024-2025</option>
                        <option value="2023-2024">2023-2024</option>
                    </select>
                    <label>Subject</label>
                    <input type="text" id="marks-subject" class="styled-input" placeholder="e.g. Mathematics">
                    <label>Score (Out of 100)</label>
                    <input type="number" id="marks-score" class="styled-input" placeholder="Enter Marks">
                    <button class="btn-glow w-100 py-3" onclick="submitMarks()">PUBLISH TO PORTAL</button>
                </div>
            </div>
        </div>
    </div>

    <div id="section-records" class="dashboard-section">
        <div class="glass-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Student Academic Directory</h4>
                <button class="btn btn-sm btn-outline-dark" onclick="loadAllRecords()"><i class="fas fa-sync"></i> Refresh Students</button>
            </div>
            <div class="table-responsive">
                <table class="table">
                    <thead class="thead-light">
                        <tr>
                            <th>Roll No</th>
                            <th>Student Name</th>
                            <th>Grade</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="all-records-table">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const _supabase = supabase.createClient('https://tqphwqjhiidgaohzllyw.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxcGh3cWpoaWlkZ2FvaHpsbHl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTEyNDIsImV4cCI6MjA4MzI4NzI0Mn0.CvxIEgEcO64TKPyHGbG1Ht-MbCpeNsPWEq1exWWvw2o');

    function showSection(sectionId) {
        document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById('section-' + sectionId).classList.add('active');
        document.getElementById('nav-' + sectionId).classList.add('active');

        if(sectionId === 'records') loadAllRecords();
    }

    async function checkFaculty() {
        const { data: { user } } = await _supabase.auth.getUser();
        if (!user) { window.location.href = 'login.html'; return; }
        
        const { data: profile } = await _supabase.from('profiles').select('*').eq('id', user.id).single();
        if(profile) {
            document.getElementById('faculty-welcome').innerText = "Welcome, Prof. " + profile.full_name;
        }
    }

    async function searchStudent() {
        const roll = document.getElementById('search-roll').value;
        const { data, error } = await _supabase.from('profiles').select('*').eq('roll_no', roll).single();

        if (data) {
            document.getElementById('student-result').style.display = 'block';
            document.getElementById('res-name').innerText = data.full_name;
            document.getElementById('res-std').innerText = "Grade: " + data.standard;
            document.getElementById('target-student-id').value = data.id;
        } else {
            alert("Roll Number not found!");
        }
    }

    async function submitMarks() {
        const s_id = document.getElementById('target-student-id').value;
        const sub = document.getElementById('marks-subject').value;
        const scr = document.getElementById('marks-score').value;
        const yr = document.getElementById('marks-year').value;

        if(!s_id || !sub || !scr) { alert("Fill all details and search for a student!"); return; }

        const { error } = await _supabase.from('marks').insert([{
            student_id: s_id,
            subject: sub,
            score: parseInt(scr),
            academic_year: yr
        }]);

        if (error) alert("Error: " + error.message);
        else {
            alert("Marks published successfully!");
            document.getElementById('marks-score').value = "";
            document.getElementById('marks-subject').value = "";
        }
    }

    // --- UPDATED VIEW RECORDS LOGIC ---

    async function loadAllRecords() {
        const table = document.getElementById('all-records-table');
        table.innerHTML = "<tr><td colspan='4' class='text-center'>Fetching students...</td></tr>";

        // Fetch unique students from profiles
        const { data: students, error } = await _supabase
            .from('profiles')
            .select('id, full_name, roll_no, standard')
            .eq('role', 'student')
            .order('roll_no', { ascending: true });

        if(error) { console.log(error); return; }

        table.innerHTML = "";
        students.forEach(s => {
            table.innerHTML += `
                <tr class="clickable-row">
                    <td><b>${s.roll_no || 'N/A'}</b></td>
                    <td>${s.full_name}</td>
                    <td>${s.standard}</td>
                    <td>
                        <button class="btn btn-sm btn-glow" onclick="toggleStudentDetails('${s.id}', '${s.full_name}')">
                            <i class="fas fa-chevron-down"></i> View Marks
                        </button>
                    </td>
                </tr>
                <tr id="row-details-${s.id}" style="display:none; background: #f9f9f9;">
                    <td colspan="4">
                        <div id="box-${s.id}" class="detail-box">
                            <i class="fas fa-spinner fa-spin"></i> Loading marks...
                        </div>
                    </td>
                </tr>`;
        });
    }

    async function toggleStudentDetails(studentId, name) {
        const detailRow = document.getElementById(`row-details-${studentId}`);
        const box = document.getElementById(`box-${studentId}`);

        if (detailRow.style.display === 'table-row') {
            detailRow.style.display = 'none';
            return;
        }

        // Show row
        detailRow.style.display = 'table-row';

        // Fetch marks for this specific student
        const { data: marks, error } = await _supabase
            .from('marks')
            .select('*')
            .eq('student_id', studentId)
            .order('academic_year', { ascending: false });

        if (!marks || marks.length === 0) {
            box.innerHTML = `<span class="text-muted">No academic records found for ${name}.</span>`;
            return;
        }

        let html = `<h6 class="font-weight-bold" style="color:var(--sidebar-bg)">Academic History: ${name}</h6>
                    <table class="table table-sm mt-2">
                        <thead>
                            <tr><th>Year</th><th>Subject</th><th>Score</th><th>Status</th><th>Action</th></tr>
                        </thead>
                        <tbody>`;
        
        marks.forEach(m => {
            const isPass = m.score >= 35;
            html += `
                <tr>
                    <td>${m.academic_year}</td>
                    <td>${m.subject}</td>
                    <td><b>${m.score}</b>/100</td>
                    <td><span class="badge ${isPass ? 'badge-success' : 'badge-danger'}">${isPass ? 'PASS' : 'FAIL'}</span></td>
                    <td>
                        <button class="btn btn-sm text-danger" onclick="deleteRecord('${m.id}', '${studentId}', '${name}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });

        html += `</tbody></table>`;
        box.innerHTML = html;
    }

    async function deleteRecord(recordId, studentId, name) {
        if(confirm("Permanently delete this mark record?")) {
            const { error } = await _supabase.from('marks').delete().eq('id', recordId);
            if(!error) {
                // Refresh only that student's box
                const detailRow = document.getElementById(`row-details-${studentId}`);
                detailRow.style.display = 'none'; // Close it
                toggleStudentDetails(studentId, name); // Re-open to refresh
            }
        }
    }

    async function handleLogout() { await _supabase.auth.signOut(); window.location.href = 'login.html'; }
    window.onload = checkFaculty;
</script>
</body>
</html>